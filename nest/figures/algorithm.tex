\tikzstyle{smc}=[circle,
                                    thick,
                                    minimum size=1cm,
                                    draw=blue!80,
                                    fill=blue!40]
\tikzstyle{csmc}=[circle,
                                    thick,
                                    minimum size=1cm,
                                    draw=orange!80,
                                    fill=orange!20]
\tikzstyle{iter} = [text=red]

\tikzstyle{background}=[rectangle,
                                                draw=green!40,
                                                line width=0.0625cm,
                                                inner sep=0.2cm,
                                                rounded corners=0.25mm]

\tikzstyle{iterback}=[rectangle,
draw=red,
line width=0.0625cm,
inner sep=0.075cm,
rounded corners=1.25mm]

\begin{tikzpicture}[>=latex,text height=0.375ex,text depth=0.0625ex]
  \matrix[row sep=0.35cm,column sep=0.35cm] {
    %&
    \node (n1) [iter]{$n=1$}; &
    \node (n2) [iter]{$n=2$}; &
    \node (n3) [iter]{$n=3$}; &
%    \node (n4)[iter]{$n=4$}; &
%    \node (n5) [iter]{$n=5$}; &
%    \node (n6) [iter]{$n=6$}; &
%    \node (n7) [iter]{$n=7$}; &
%    \node (n8)[iter]{$n=8$}; &
    \node (n9) []{\tiny $\bullet \; \bullet \; \bullet$}; &
    \\
        \node (y1) [smc]{$y_1$}; &
        \node (y2) [smc]{$y_2$}; &
        \node (y3) [smc]{$y_3$}; &
%        \node (y4)[smc]{$y_4$}; &
%        \node (y5) [smc]{$y_5$}; &
%        \node (y6) [smc]{$y_6$}; &
%        \node (y7) [smc]{$y_7$}; &
%        \node (y8)[smc]{$y_8$}; &
        \node (y9) []{\tiny $\bullet \; \bullet \; \bullet$}; &
        \\
        \node (z_11) [csmc]{$z_{1,1}$};      &
        \node (z_12) [csmc]{$z_{1,2}$};      &
        \node (z_13) [csmc]{$z_{1,3}$};     &
%        \node (z_14) [csmc]{$z_{1,4}$};      &
%        \node (z_15) [csmc]{$z_{1,5}$};     &
%        \node (z_16) [csmc]{$z_{1,6}$};      &
%        \node (z_17) [csmc]{$z_{1,7}$};      &
%        \node (z_18) [csmc]{$z_{1,8}$};     &
        \node (z_19) []{\tiny $\bullet \; \bullet \; \bullet$};      &
        \\
        \node (d11) []{\tiny $\begin{matrix}
        	\bullet \\
        	\bullet \\
        	 \bullet \\
        	\end{matrix}
        $}; &
        \node (d12) []{\tiny $\begin{matrix}
        	\bullet \\
        	\bullet \\
        	\bullet \\
        	\end{matrix}
        	$}; &
        \node (d13) []{\tiny $\begin{matrix}
        	\bullet \\
        	\bullet \\
        	\bullet \\
        	\end{matrix}
        	$}; &
%        \node (d14) []{\tiny $\begin{matrix}
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d15) []{\tiny $\begin{matrix}
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d16) []{\tiny $\begin{matrix}
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d17) []{\tiny $\begin{matrix}
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d18) []{\tiny $\begin{matrix}
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
        \node (d19) []{\tiny $\begin{matrix}
        	\bullet \; \; \; \; \\
        	\; \; \bullet \; \; \\
        	\; \; \; \; \bullet \\
        	\end{matrix}
        	$}; &
        \\
        \node (z_M1) [csmc]{$z_{M,1}$};      &
        \node (z_M2) [csmc]{$z_{M,2}$};      &
        \node (z_M3) [csmc]{$z_{M,3}$};     &
%        \node (z_M4) [csmc]{$z_{M,4}$};      &
%        \node (z_M5) [csmc]{$z_{M,5}$};     &
%        \node (z_M6) [csmc]{$z_{M,6}$};      &
%        \node (z_M7) [csmc]{$z_{M,7}$};      &
%        \node (z_M8) [csmc]{$z_{M,8}$};     &
        \node (z_M9) []{\tiny $\bullet \; \bullet \; \bullet$};      &
        \\
        \node (d21) []{\tiny $\begin{matrix}
        	\\\\
        	\bullet \\
        	\bullet \\
        	\bullet \\
        	\end{matrix}
        	$}; &
        \node (d22) []{\tiny $\begin{matrix}
        	\\\\
        	\bullet \\
        	\bullet \\
        	\bullet \\
        	\end{matrix}
        	$}; &
        \node (d23) []{\tiny $\begin{matrix}
        	\\\\
        	\bullet \\
        	\bullet \\
        	\bullet \\
        	\end{matrix}
        	$}; &
%        \node (d24) []{\tiny $\begin{matrix}
%        	\\
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d25) []{\tiny $\begin{matrix}
%        	\\
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d26) []{\tiny $\begin{matrix}
%        	\\
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d27) []{\tiny $\begin{matrix}
%        	\\
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
%        \node (d28) []{\tiny $\begin{matrix}
%        	\\
%        	\bullet \\
%        	\bullet \\
%        	\bullet \\
%        	\end{matrix}
%        	$}; &
        \node (d29) []{\tiny $\begin{matrix}
        	\\\\
        	\bullet \; \; \; \; \\
        	\; \; \bullet \; \; \\
        	\; \; \; \; \bullet \\
        	\end{matrix}
        	$}; &
        \\
    };
    
%    \node (conv) []{$\E[f(y,\frac{1}{M}\sum_{m=1}^{M} \phi(y,z_m))]$}
%
%    \path[->] (d19) -- (conv.east);
        %(A) edge[thick] (x)	% 

    \begin{pgfonlayer}{background}
    \node [iterback,
    fit=(y1) (z_M1)] {};
        \node [iterback,
        fit=(y2) (z_M2)] {};
            \node [iterback,
            fit=(y3) (z_M3)] {};
%                        \node [iterback,
%                        fit=(y4) (z_M4)] {};
%                                    \node [iterback,
%                                    fit=(y5) (z_M5)] {};
%                                                \node [iterback,
%                                                fit=(y6) (z_M6)] {};
%                                                            \node [iterback,
%                                                            fit=(y7) (z_M7)] {};
%                                                                        \node [iterback,
%                                                                        fit=(y8) (z_M8)] {};
    \end{pgfonlayer}
        ;
    \begin{pgfonlayer}{background}
    \node [background,
    fit=(y1) (z_M1) (z_M9)] {};
    \end{pgfonlayer}
\end{tikzpicture}
